
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Vectors &#8212; The Feltor guide book</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'vector-juggling';</script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="ODE integrators" href="timesteppers.html" />
    <link rel="prev" title="Welcome" href="welcome.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="welcome.html">
  
  
  
  
  
  
    <p class="title logo__title">The Feltor guide book</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">dg/algorithm.h</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Vectors</a></li>
<li class="toctree-l1"><a class="reference internal" href="timesteppers.html">ODE integrators</a></li>
<li class="toctree-l1"><a class="reference internal" href="grids.html">Grids and derivatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="solvers.html">Solvers in Feltor</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">dg/geometries/geometries.h</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="geometries.html">Curvilinear grids</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">dg/matrix/matrix.h</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="matrixfunction.html">Matrix functions</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">dg/file/file.h</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="json-utilities.html">JSON utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="netcdf-utilities.html">NetCDF utilities</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">dg/exblas/exblas.h</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="reproducibility.html">Reproducibility and Accuracy</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Projects</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="new-project.html">Create your own project</a></li>
<li class="toctree-l1"><a class="reference internal" href="timesteppers2.html">Advanced Timesteppers</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/vector-juggling.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Vectors</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-first-example">A first example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-independent-code">Platform independent code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arbitrarily-parallel-the-blas1-subroutine">Arbitrarily parallel - The blas1 subroutine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-collection-of-vectors-recursive-execution">A collection of vectors - recursive execution</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="vectors">
<span id="sec-vectors"></span><h1>Vectors<a class="headerlink" href="#vectors" title="Link to this heading">#</a></h1>
<p>Assume we want to compute <span class="math notranslate nohighlight">\(\vec y =  a\vec x+b\vec y\)</span> where <span class="math notranslate nohighlight">\(\vec x\)</span> and <span class="math notranslate nohighlight">\(\vec y\)</span> are vectors and a and b are constants.
Furthermore, assume we wish to compute the dot product
of <span class="math notranslate nohighlight">\(\vec x\)</span> and <span class="math notranslate nohighlight">\(\vec y\)</span>. And finally assume that we want to do this for both small
and large vectors, that is we want to eventually write parallel code using for example GPUs.
The following tutorial shows how to do exactly that
and more using the dg library.</p>
<section id="a-first-example">
<h2>A first example<a class="headerlink" href="#a-first-example" title="Link to this heading">#</a></h2>
<p>First, we have to include the main feltor library header:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// include the dg-library</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;dg/algorithm.h&quot;</span>

<span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">},</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">};</span>
<span class="c1">// compute a*x+b*y and store it in y</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="c1">// compute Sum_i x_i y_i</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="c1">// output should be 8</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8</span>
</pre></div>
</div>
<p>In this code we encounter our first two dg functions, namely <code class="docutils literal notranslate"><span class="pre">dg::blas1::axpby</span></code>
and <code class="docutils literal notranslate"><span class="pre">dg::blas1::dot</span></code>. They perform very basic operations, namely adding vectors
and computing scalar products respectively. (You can look up their formal documentation <a class="reference external" href="https://mwiesenberger.github.io/feltor/dg/html/group__blas1.html">here</a>).
The remarkable thing about these two functions is that they are templates.
This means you can call them for many different vector classes. We can change the type of <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>;</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// works as well</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8</span>
<span class="c1">//or</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">host_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8</span>
</pre></div>
</div>
<p>All three versions have the same result.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All of these examples
execute on a single CPU thread, that is the compiler chooses the same
<strong>serial</strong> implementation of the vector addition and the scalar product.</p>
</div>
<p>So let us increase the vector size to say, a Million. Wouldn’t it
be better to perform these operations in parallel? And a measurement
of the execution time would also be nice:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//use the thrust library to allocate memory on the device</span>
<span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="c1">//create a Timer</span>
<span class="n">dg</span><span class="o">::</span><span class="n">Timer</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="c1">//start the clock</span>
<span class="n">t</span><span class="p">.</span><span class="n">tic</span><span class="p">();</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="c1">//stop the clock</span>
<span class="n">t</span><span class="p">.</span><span class="n">toc</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Axpby took &quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">diff</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="n">t</span><span class="p">.</span><span class="n">tic</span><span class="p">();</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="n">t</span><span class="p">.</span><span class="n">toc</span><span class="p">();</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Dot   took &quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">diff</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="c1">//output should be ... large</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="c1">//Axpby took 0.913942s</span>
<span class="c1">//Dot   took 0.883924s</span>
<span class="c1">//4e+06</span>
</pre></div>
</div>
<p>The first thing to notice is that we now use the thrust::device_vector<double> class. This is a vector class of the thrust library, which allocates memory on a GPU. The compiler recognizes that dg::blas1::axpby and dg::blas1::dot are now called with a GPU vector class and redirects the call to the corresponding CUDA implementation.</p>
<p>When using a GPU a natural question is how the synchronization is done between the GPU kernel queue and the host execution. The good news is that you do not need to manually synchronize the GPUs. The library will do it for you whenever it is needed.</p>
<p>If you do not have a GPU you can also define the THRUST_DEVICE_SYSTEM=THRUST_DEVICE_SYSTEM_OMP Macro, then the call redirects to a OpenMP parallelized version or THRUST_DEVICE_SYSTEM=THRUST_DEVICE_SYSTEM_CPP (like it is done in this notebook because xeus-cling does not support OpenMP or cuda very well) then the calls redirect to the serial version again. This is a specialty of the thrust::device_vector class of the thrust library that is included in dg/algorithm.h.</p>
<p>You could also use your own
vector class in the <code class="docutils literal notranslate"><span class="pre">dg::blas1</span></code> functions. This is an advanced feature
and requires you to provide a specialization of <code class="docutils literal notranslate"><span class="pre">dg::TensorTraits</span></code>
for your class, where you specify the parallelization strategy that
the libary should choose and how the data is laid out in memory.
Please consult the <a class="reference external" href="https://mwiesenberger.github.io/feltor/dg/html/index.html#dispatch">documentation</a> for further details on
how we dispatch the blas functions
and our template traits system.</p>
<p>The dg::Timer measures the time it took to execute the functions.</p>
<p>So, what if the vector size is even larger 1e8 say? Then an MPI implementation would be handy, wouldn’t it:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The following cell will not compile if you do not have MPI installed.. You will need to copy-paste the below code to a file and compile it using the instructions in the quick-start guide.</p>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">//activate MPI in FELTOR</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;mpi.h&quot;</span><span class="c1"> //needs to be included **before** dg/algorithm.h</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;dg/algorithm.h&quot;</span>


<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">    </span><span class="c1">//init MPI</span>
<span class="w">    </span><span class="n">MPI_Init</span><span class="p">(</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">argv</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//let&#39;s take all processes</span>
<span class="w">    </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">comm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MPI_COMM_WORLD</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//get the number of MPI processes in the communicator</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">np</span><span class="p">,</span><span class="n">rank</span><span class="p">;</span>
<span class="w">    </span><span class="n">MPI_Comm_size</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">np</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//get the rank of the calling process</span>
<span class="w">    </span><span class="n">MPI_Comm_rank</span><span class="p">(</span><span class="n">comm</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">rank</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//allocate and initialize local memory</span>
<span class="w">    </span><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x_local</span><span class="p">(</span><span class="w"> </span><span class="mf">1e8</span><span class="o">/</span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">y_local</span><span class="p">(</span><span class="mf">1e8</span><span class="o">/</span><span class="n">np</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="w">    </span><span class="c1">//combine the local vectors to a global MPI vector</span>
<span class="w">    </span><span class="n">dg</span><span class="o">::</span><span class="n">MPI_Vector</span><span class="o">&lt;</span><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">(</span><span class="n">x_local</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>
<span class="w">    </span><span class="n">dg</span><span class="o">::</span><span class="n">MPI_Vector</span><span class="o">&lt;</span><span class="n">thrust</span><span class="o">::</span><span class="n">device_vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">(</span><span class="n">y_local</span><span class="p">,</span><span class="w"> </span><span class="n">comm</span><span class="p">);</span>

<span class="w">    </span><span class="c1">//now repeat the operations from before...</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="w">    </span><span class="n">dg</span><span class="o">::</span><span class="n">Timer</span><span class="w"> </span><span class="n">t</span><span class="p">;</span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">tic</span><span class="p">();</span>
<span class="w">    </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">toc</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rank</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Axpby took &quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">diff</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">tic</span><span class="p">();</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="w">    </span><span class="n">t</span><span class="p">.</span><span class="n">toc</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rank</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Dot   took &quot;</span><span class="o">&lt;&lt;</span><span class="n">t</span><span class="p">.</span><span class="n">diff</span><span class="p">()</span><span class="o">&lt;&lt;</span><span class="s">&quot;s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">rank</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="c1">//be a good MPI citizen and clean up</span>
<span class="w">    </span><span class="n">MPI_Finalize</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We have just written a hybrid MPI + X code, where X can be either serial, OpenMP or CUDA depending on how the code is compiled!</p>
</div>
<p>One remaining thing is that we quickly get tired
of writing <code class="docutils literal notranslate"><span class="pre">thrust::device_vector&lt;double&gt;</span></code> and
especially <code class="docutils literal notranslate"><span class="pre">dg::MPI_Vector&lt;thrust::device_vector&lt;double&gt;&gt;</span></code>.
So we invented convenient typedefs:
<code class="docutils literal notranslate"><span class="pre">dg::DVec</span> <span class="pre">x_local(</span> <span class="pre">1e8/np,</span> <span class="pre">2),</span> <span class="pre">y_local(1e8/np,</span> <span class="pre">4)</span> <span class="pre">dg::x::DVec</span> <span class="pre">x(x_local,</span> <span class="pre">comm),</span> <span class="pre">y(y_local,</span> <span class="pre">comm);</span></code></p>
<p>which is completely equivalent to the corresponding lines 18 and 20/ 21 above.</p>
</section>
<section id="platform-independent-code">
<h2>Platform independent code<a class="headerlink" href="#platform-independent-code" title="Link to this heading">#</a></h2>
<p>The remarkable thing in the above examples is that two lines of code never changed, even if we changed the class of vectors that we use it on</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="c1">// This is platform independent code</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
</pre></div>
</div>
<p>This is a first example of <strong>platform independent code</strong>.
It gives us an abstract way to perform vector operations on many different types and with different parallelization. If we implement an algorithm only in terms of <code class="docutils literal notranslate"><span class="pre">dg::blas1</span></code> or similar functions, then
this algorithm is <strong>automatically parallelized</strong> for a variety of hardware and works with <strong>many different vector types</strong>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is in fact exactly what the dg library does. It provides a set of algorithms all implemented as templates of (at least) the vector class using only the dg::blas1 (and later dg::blas2) functions. We will encounter a first example of such an algorithm in the next chapter of the tutorial: timesteppers.</p>
</div>
</section>
<section id="arbitrarily-parallel-the-blas1-subroutine">
<h2>Arbitrarily parallel - The blas1 subroutine<a class="headerlink" href="#arbitrarily-parallel-the-blas1-subroutine" title="Link to this heading">#</a></h2>
<p>One remaining question in this chapter is: what if we do not want to add vectors
but multiply them instead? Or take the exponential of each element?
There is a selection of predefined <code class="docutils literal notranslate"><span class="pre">dg::blas1</span></code> operations
you can choose from for example <code class="docutils literal notranslate"><span class="pre">dg::blas1::pointwiseDot</span></code> or <code class="docutils literal notranslate"><span class="pre">dg::blas1::scal</span></code>. Check out the
<a class="reference external" href="https://mwiesenberger.github.io/feltor/dg/html/group__blas1.html">documentation</a>.</p>
<p>If this still does not satisfy your needs, the answer probably is
the <code class="docutils literal notranslate"><span class="pre">dg::blas1::subroutine</span></code>.</p>
<div class="admonition-really-blas1 admonition">
<p class="admonition-title">Really blas1?</p>
<p><code class="docutils literal notranslate"><span class="pre">blas</span></code> stands for basic linear algebra subroutins, the 1 stands for pure vector operations. In this sense <code class="docutils literal notranslate"><span class="pre">blas1::pointwiseDot</span></code> or <code class="docutils literal notranslate"><span class="pre">blas1::subroutine</span></code> are actually misnomers, since neither function is linear, nor are they part of the original blas library.</p>
</div>
<p>As an example, let us assume that we have two vectors <code class="docutils literal notranslate"><span class="pre">v</span></code> and <code class="docutils literal notranslate"><span class="pre">w</span></code> and we want to compute the elementwise expression <span class="math notranslate nohighlight">\(v_i = v_i v_i + a\sin(w_i)\)</span>, where <span class="math notranslate nohighlight">\(a\)</span> is a given scalar. The first thing is to write a lambda with our expression and then apply it to all elements in <code class="docutils literal notranslate"><span class="pre">v</span></code> and <code class="docutils literal notranslate"><span class="pre">w</span></code></p>
<div class="admonition-lambdas-are-amazing admonition">
<p class="admonition-title">Lambdas are amazing</p>
<p>Lambda functions are very useful and will appear continuously throughout this guide, so it is a good idea to refresh your knowledge about them.
A good watch on youtube is for example <a class="reference external" href="https://www.youtube.com/watch?v=3jCOwajNch0">Lambdas from Scratch - Arthur O’Dwye</a></p>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">8.</span><span class="p">;</span>
<span class="k">auto</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="o">&amp;</span><span class="p">]</span><span class="n">DG_DEVICE</span><span class="p">(</span><span class="w"> </span><span class="kt">double</span><span class="o">&amp;</span><span class="w"> </span><span class="n">vi</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">wi</span><span class="w"> </span><span class="p">){</span>
<span class="w">                              </span><span class="n">vi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vi</span><span class="o">*</span><span class="n">vi</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">a</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">wi</span><span class="p">);</span>
<span class="w">                          </span><span class="p">};</span>
<span class="n">dg</span><span class="o">::</span><span class="n">HVec</span><span class="w"> </span><span class="nf">v</span><span class="p">(</span><span class="w"> </span><span class="mf">1e6</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">w</span><span class="p">(</span><span class="mf">1e6</span><span class="p">,</span><span class="mi">4</span><span class="p">);</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">subroutine</span><span class="p">(</span><span class="w"> </span><span class="n">lambda</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="n">w</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// -2.05442</span>
</pre></div>
</div>
<p>In the above example we have two host vectors <code class="docutils literal notranslate"><span class="pre">dg::HVec</span> <span class="pre">v</span></code> and <code class="docutils literal notranslate"><span class="pre">w</span></code>. In a shared
memory code these will be declared as <code class="docutils literal notranslate"><span class="pre">dg::DVec</span></code>
In an MPI implementation we would simply write <code class="docutils literal notranslate"><span class="pre">dg::x::DVec</span></code> instead of <code class="docutils literal notranslate"><span class="pre">dg::DVec</span></code>.</p>
<p><code class="docutils literal notranslate"><span class="pre">dg::blas1::subroutine</span></code> simply calls the given <strong>custom Functor</strong> (in the above case a lambda) for each element in <code class="docutils literal notranslate"><span class="pre">v</span></code> and <code class="docutils literal notranslate"><span class="pre">w</span></code>. There can be an <strong>arbitrary</strong> number of arguments to the subroutine function (in fact there have to be as many as arguments to the functor/lambda).</p>
<p>This in fact means that <code class="docutils literal notranslate"><span class="pre">dg::blas1::subroutine</span></code> is able to compute <strong>any</strong> trivially parallel
operation with <strong>any</strong> number of inputs and outputs.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you do not think this is pure magic, stop here and read again :)
(On a technical note, this neat behaviour is possible through <code class="docutils literal notranslate"><span class="pre">C++-11</span></code>-style
template parameter packs).</p>
</div>
</section>
<section id="a-collection-of-vectors-recursive-execution">
<h2>A collection of vectors - recursive execution<a class="headerlink" href="#a-collection-of-vectors-recursive-execution" title="Link to this heading">#</a></h2>
<p>In many practical problems of fluid dynamics we not only want to integrate one variable, <code class="docutils literal notranslate"><span class="pre">x</span></code> say in time, but several. For example we may want to integrate both density <span class="math notranslate nohighlight">\(n\)</span> and velocity <span class="math notranslate nohighlight">\(v\)</span>. Then, the complete
set of variables should be tied together in a single entity.
In Feltor you do this simply by allocating “Vectors of vectors”. The underlying engine automatically (and recursively) expands such constructions.
Let us see an example:</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="w"> </span><span class="nf">two</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">four</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">two</span><span class="p">,</span><span class="n">two</span><span class="p">},</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">four</span><span class="p">,</span><span class="n">four</span><span class="p">};</span>
<span class="c1">// compute a*x+b*y and store it in y</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="c1">// compute Sum_i x_i y_i</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="c1">// output should be large ...</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8000</span>
</pre></div>
</div>
<p>In this example we have an array of two large vectors (that are not filled with too exciting values, but it is just to show that the code still works). It is also possible to have a vector or map of vectors</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="w"> </span><span class="nf">two</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">four</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="n">two</span><span class="p">},</span><span class="w"> </span><span class="n">y</span><span class="p">{</span><span class="mi">2</span><span class="p">,</span><span class="n">four</span><span class="p">};</span>
<span class="c1">// compute a*x+b*y and store it in y</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="c1">// compute Sum_i x_i y_i</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="c1">// output should be large ...</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8000</span>
</pre></div>
</div>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.25</span><span class="p">;</span>
<span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="w"> </span><span class="nf">two</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">),</span><span class="w"> </span><span class="n">four</span><span class="p">(</span><span class="w"> </span><span class="mf">1e3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">);</span>
<span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">DVec</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="s">&quot;density&quot;</span><span class="p">,</span><span class="n">two</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">two</span><span class="p">}},</span>
<span class="w">                                </span><span class="n">y</span><span class="w"> </span><span class="p">{{</span><span class="w"> </span><span class="s">&quot;density&quot;</span><span class="p">,</span><span class="n">four</span><span class="p">},</span><span class="w"> </span><span class="p">{</span><span class="s">&quot;velocity&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">four</span><span class="p">}};</span>
<span class="c1">// compute a*x+b*y and store it in y</span>
<span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">axpby</span><span class="p">(</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">);</span>
<span class="c1">// compute Sum_i x_i y_i</span>
<span class="kt">double</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dg</span><span class="o">::</span><span class="n">blas1</span><span class="o">::</span><span class="n">dot</span><span class="p">(</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">);</span>
<span class="c1">// output should be large ...</span>
<span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="c1">// 8000</span>
</pre></div>
</div>
<p>Since the implementation works recursively, the “innver vector” can be a recusive vector again that is something like  <code class="docutils literal notranslate"><span class="pre">std::vector&lt;std::array&lt;dg::DVec,2&gt;&gt;</span></code> is also possible.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="welcome.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Welcome</p>
      </div>
    </a>
    <a class="right-next"
       href="timesteppers.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">ODE integrators</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-first-example">A first example</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#platform-independent-code">Platform independent code</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#arbitrarily-parallel-the-blas1-subroutine">Arbitrarily parallel - The blas1 subroutine</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#a-collection-of-vectors-recursive-execution">A collection of vectors - recursive execution</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Matthias Wiesenberger
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>